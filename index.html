<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteios 0xGus - Testnet Monad</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ancizar+Sans:ital,wght@0,100..1000;1,100..1000&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');
        body {
            font-family: 'Ancizar Sans', sans-serif;
        }
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
        }
        .image-3d {
            transition: transform 0.1s ease-out;
            transform-style: preserve-3d;
        }
        .truncate-address {
            display: inline-block;
            width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1f2937;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            text-align: center;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        #cookieConsent {
            padding: 20px;
            font-size: 1.1rem;
        }
        #cookieConsent p {
            margin-bottom: 10px;
        }
        #acceptCookies {
            padding: 12px 24px;
            font-size: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">
    <!-- Pop-up Overlay -->
    <div id="popupOverlay" class="popup-overlay"></div>

    <!-- Pop-ups -->
    <div id="errorPopup" class="popup">
        <p id="errorMessage"></p>
        <button id="closeErrorPopup" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Fechar</button>
    </div>
    <div id="thanksPopup" class="popup">
        <p>Obrigado por ajudar a comunidade Monad. Boa Sorte!</p>
        <button id="closeThanksPopup" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Fechar</button>
    </div>
    <div id="usernamePopup" class="popup">
        <p>Por favor, insira seu username do X:</p>
        <input id="twitterUsernameInput" type="text" placeholder="username ou @username" class="border border-gray-600 bg-gray-800 text-white p-2 w-full mb-2 rounded">
        <button id="submitUsername" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Enviar</button>
    </div>
    <div id="cookieConsent" class="popup">
        <p>Este site usa cookies para melhorar sua experiência.</p>
        <button id="acceptCookies" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Aceitar</button>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 w-full py-4 shadow-lg">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Sorteios 0xGus</h1>
            <div class="relative">
                <button id="walletButton" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Conectar Carteira</button>
                <div id="walletMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 text-white rounded-lg shadow-lg">
                    <div class="p-2 border-b border-gray-600">
                        <p><strong>Endereço:</strong> <span id="userAddress" class="truncate-address"></span></p>
                    </div>
                    <div class="p-2 border-b border-gray-600">
                        <input id="xUsernameInput" type="text" placeholder="username ou @username" class="border border-gray-600 bg-gray-800 text-white p-1 w-full text-sm rounded">
                        <button id="updateXUsername" class="mt-1 bg-green-600 text-white px-2 py-1 rounded w-full hover:bg-green-700">Atualizar @X</button>
                    </div>
                    <button id="disconnectWallet" class="w-full text-left p-2 hover:bg-gray-600">Desconectar Carteira</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 flex flex-col md:flex-row gap-8 flex-1">
        <!-- Left Side: Image -->
        <div class="md:w-1/2">
            <h2 class="text-xl font-semibold mb-4 text-white"> Monadverse: Capítulo 1 + 5 MON</h2>
            <div class="overflow-hidden rounded-lg">
                <img id="sorteioImage" src="/images/mv1.avif" alt="Sorteio 0xGus" class="w-full h-auto image-3d">
            </div>
        </div>

        <!-- Right Side: Ticket Purchase -->
        <div class="md:w-1/2">
            <h2 class="text-xl font-semibold mb-4 text-white">Comprar Tickets</h2>
            <p class="text-gray-400 mb-2">Data do sorteio: 30 de Junho de 2025</p>
            <div class="bg-gray-800 p-6 rounded-lg">
                <p><strong>Preço do Ticket:</strong> <span id="ticketPrice">0.01</span> MON</p>
                <p><strong>Carteiras Participantes:</strong> <span id="participantCount">0</span></p>
                <p><strong>Seus Tickets:</strong> <span id="ticketCount">0</span></p>
                <div class="mt-4">
                    <div class="flex items-center gap-4">
                        <div>
                            <label for="ticketQuantity" class="block text-sm font-medium">Quantidade de Tickets:</label>
                            <input id="ticketQuantity" type="number" min="1" value="1" class="border border-gray-600 bg-gray-800 text-white p-2 w-24 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Saldo:</label>
                            <p id="walletBalance" class="text-gray-400">0 MON</p>
                        </div>
                    </div>
                    <p><strong>Total:</strong> <span id="totalCost">0.01</span> MON</p>
                    <p id="raffleStatus" class="text-red-400 mt-2 hidden">Sorteio Fechado</p>
                    <button id="buyTickets" class="bg-gray-600 text-white px-4 py-2 rounded w-full mt-2 cursor-not-allowed" disabled>Conecte sua wallet primeiro</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Ranking and Past Winners -->
    <section class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div id="participantsSection">
                <h2 class="text-xl font-semibold mb-4 text-white">Ranking de Participantes (Top 5)</h2>
                <ul id="participantsList" class="bg-gray-800 p-4 rounded-lg list-none pl-5"></ul>
            </div>
            <div id="winnersSection">
                <h2 class="text-xl font-semibold mb-4 text-white">Ganhadores Anteriores</h2>
                <ul id="pastWinnersList" class="bg-gray-800 p-4 rounded-lg list-disc pl-5"></ul>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white w-full py-4">
        <div class="container mx-auto px-4 text-center">
            <p>Desenvolvido por <a href="https://x.com/0xGustavo" target="_blank" class="underline hover:text-green-600">0xGus</a></p>
        </div>
    </footer>

    <script>
        // Configurações da Monad Testnet
        const MONAD_TESTNET = {
            chainId: "0x279f", // 10143
            chainName: "Monad Testnet",
            rpcUrls: ["https://testnet-rpc.monad.xyz"],
            nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
            blockExplorerUrls: ["https://testnet.monadexplorer.com"]
        };
        const CONTRACT_ADDRESS = "0x12A322c1C44CD5b90f4BE8E13F2e75BbAAb96799";

        // ABI do contrato
        const CONTRACT_ABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"participant","type":"address"},{"indexed":false,"internalType":"string","name":"newAlias","type":"string"}],"name":"AliasUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"raffleNumber","type":"uint256"}],"name":"RaffleStarted","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"participant","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"},{"indexed":false,"internalType":"string","name":"_alias","type":"string"}],"name":"TicketPurchased","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newPrice","type":"uint256"}],"name":"TicketPriceUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"raffleNumber","type":"uint256"}],"name":"WinnerDrawn","type":"event"},
            {"inputs":[{"internalType":"string","name":"_alias","type":"string"}],"name":"buyTicket","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"string","name":"_alias","type":"string"}],"name":"buyTickets","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"string","name":"_newAlias","type":"string"}],"name":"buyTicketsWithNewAlias","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"drawWinner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_participant","type":"address"}],"name":"getAlias","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getParticipants","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getPastWinners","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_participant","type":"address"}],"name":"getTicketCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isRaffleOpen","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"raffleCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"refundParticipants","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"startRaffle","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_newPrice","type":"uint256"}],"name":"setTicketPrice","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"ticketPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"_newAlias","type":"string"}],"name":"updateAlias","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"stateMutability":"payable","type":"receive"}
        ];

        // Estado global
        let web3, contract, userAddress, isWalletConnected = false, isConnecting = false, isProcessing = false;
        let cache = { data: null, timestamp: 0, validDuration: 60000 }; // Cache de 60 segundos

        // Inicialização
        async function init() {
            if (!window.ethereum || !window.ethereum.isMetaMask) {
                showErrorPopup("MetaMask não está instalado. Instale a extensão MetaMask.");
                return;
            }

            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

            // Listeners (adicionados apenas uma vez)
            document.getElementById("walletButton").addEventListener("click", debounce(connectWallet, 500));
            document.getElementById("disconnectWallet").addEventListener("click", disconnectWallet);
            document.getElementById("updateXUsername").addEventListener("click", updateXUsername);
            document.getElementById("buyTickets").addEventListener("click", debounce(handleBuyTickets, 500));
            document.getElementById("ticketQuantity").addEventListener("input", updateTotalCost);
            document.getElementById("acceptCookies").addEventListener("click", acceptCookies);
            document.getElementById("closeErrorPopup").addEventListener("click", () => hidePopup("errorPopup"));
            document.getElementById("closeThanksPopup").addEventListener("click", () => hidePopup("thanksPopup"));
            document.getElementById("submitUsername").addEventListener("click", submitTwitterUsername);
            setupImage3DEffect();
            setupMenuCloseListener();

            // Verificar cookies sem conectar automaticamente
            if (Cookies.get("acceptedCookies")) {
                document.getElementById("cookieConsent").style.display = "none";
                if (Cookies.get("userAddress")) {
                    userAddress = Cookies.get("userAddress");
                    isWalletConnected = true;
                    document.getElementById("walletButton").innerText = `Carteira: ${truncateAddress(userAddress)}`;
                    document.getElementById("walletMenu").classList.remove("hidden");
                    document.getElementById("userAddress").innerText = userAddress;
                    const savedUsername = Cookies.get("xUsername");
                    document.getElementById("xUsernameInput").value = savedUsername || "";
                    if (!savedUsername) {
                        showUsernamePopup();
                    }
                    updateBuyButton();
                }
            }
            await updateUI();
            setInterval(updateUI, 10000); // Atualizar a cada 10 segundos
        }

        // Função debounce para evitar cliques rápidos
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Conectar MetaMask
        async function connectWallet() {
            if (!window.ethereum || !window.ethereum.isMetaMask) {
                showErrorPopup("MetaMask não está instalado. Instale a extensão MetaMask.");
                return;
            }
            if (isConnecting) {
                showErrorPopup("Uma solicitação de conexão está pendente. Por favor, aguarde.");
                return;
            }
            isConnecting = true;
            try {
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                userAddress = accounts[0];

                // Verificar rede
                const chainId = await window.ethereum.request({ method: "eth_chainId" });
                if (chainId !== MONAD_TESTNET.chainId) {
                    try {
                        await window.ethereum.request({
                            method: "wallet_switchEthereumChain",
                            params: [{ chainId: MONAD_TESTNET.chainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: "wallet_addEthereumChain",
                                params: [{
                                    chainId: MONAD_TESTNET.chainId,
                                    chainName: MONAD_TESTNET.chainName,
                                    rpcUrls: MONAD_TESTNET.rpcUrls,
                                    nativeCurrency: MONAD_TESTNET.nativeCurrency,
                                    blockExplorerUrls: MONAD_TESTNET.blockExplorerUrls
                                }],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }

                isWalletConnected = true;
                document.getElementById("walletButton").innerText = `Carteira: ${truncateAddress(userAddress)}`;
                document.getElementById("walletMenu").classList.remove("hidden");
                document.getElementById("userAddress").innerText = userAddress;
                Cookies.set("userAddress", userAddress, { expires: 7 });
                const savedUsername = Cookies.get("xUsername");
                if (savedUsername) {
                    document.getElementById("xUsernameInput").value = savedUsername;
                } else {
                    showUsernamePopup();
                }
                updateBuyButton();
                await updateUI();
            } catch (error) {
                console.error("Erro ao conectar MetaMask:", error);
                if (error.message.includes("user rejected") || error.code === 4001) {
                    showErrorPopup("Você cancelou a transação no MetaMask. Por favor, autorize a transação para continuar.");
                } else {
                    showErrorPopup(error.message || "Erro ao conectar MetaMask. Verifique sua carteira e rede.");
                }
            } finally {
                isConnecting = false;
            }
        }

        // Desconectar carteira
        function disconnectWallet() {
            userAddress = null;
            isWalletConnected = false;
            Cookies.remove("userAddress");
            Cookies.remove("xUsername");
            document.getElementById("walletButton").innerText = "Conectar Carteira";
            document.getElementById("walletMenu").classList.add("hidden");
            document.getElementById("userAddress").innerText = "";
            document.getElementById("xUsernameInput").value = "";
            document.getElementById("walletBalance").innerText = "0 MON";
            updateBuyButton();
            cache = { data: null, timestamp: 0, validDuration: 60000 };
            updateUI();
        }

        // Normalizar username do X
        function normalizeXUsername(username) {
            return username.startsWith("@") ? username : `@${username}`;
        }

        // Validar username do X
        function isValidXUsername(username) {
            const cleanUsername = username.startsWith("@") ? username.slice(1) : username;
            return cleanUsername.length > 0 && /^[a-zA-Z0-9_]+$/.test(cleanUsername);
        }

        // Atualizar username do X
        async function updateXUsername() {
            const username = document.getElementById("xUsernameInput").value;
            if (!isValidXUsername(username)) {
                showErrorPopup("Insira um username válido do X (ex.: @username, apenas letras, números e sublinhados).");
                return;
            }
            if (!isWalletConnected) {
                showErrorPopup("Conecte sua carteira primeiro.");
                return;
            }
            try {
                isProcessing = true;
                const normalizedUsername = normalizeXUsername(username);
                await contract.methods.updateAlias(normalizedUsername).send({ from: userAddress });
                Cookies.set("xUsername", normalizedUsername, { expires: 7 });
                document.getElementById("xUsernameInput").value = normalizedUsername;
                showThanksPopup();
                cache = { data: null, timestamp: 0, validDuration: 60000 };
                await updateUI();
            } catch (error) {
                console.error("Erro ao atualizar username:", error);
                if (error.message.includes("user rejected") || error.code === 4001) {
                    showErrorPopup("Você cancelou a transação no MetaMask. Por favor, autorize a transação para continuar.");
                } else {
                    showErrorPopup(error.message || "Erro ao atualizar username do X.");
                }
            } finally {
                isProcessing = false;
            }
        }

        // Popup de username
        function showUsernamePopup() {
            document.getElementById("twitterUsernameInput").value = Cookies.get("xUsername") || "";
            document.getElementById("usernamePopup").style.display = "block";
            document.getElementById("popupOverlay").style.display = "block";
        }

        function submitTwitterUsername() {
            const username = document.getElementById("twitterUsernameInput").value;
            if (!isValidXUsername(username)) {
                showErrorPopup("Insira um username válido do X (ex.: @username, apenas letras, números e sublinhados).");
                return;
            }
            const normalizedUsername = normalizeXUsername(username);
            Cookies.set("xUsername", normalizedUsername, { expires: 7 });
            document.getElementById("xUsernameInput").value = normalizedUsername;
            hidePopup("usernamePopup");
        }

        function truncateAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Atualizar custo total
        async function updateTotalCost() {
            const quantity = parseInt(document.getElementById("ticketQuantity").value) || 1;
            let ticketPrice;
            if (cache.data && Date.now() - cache.timestamp < cache.validDuration) {
                ticketPrice = cache.data.ticketPrice;
            } else {
                ticketPrice = await retryCall(() => contract.methods.ticketPrice().call());
                cache.data = cache.data || {};
                cache.data.ticketPrice = ticketPrice;
                cache.timestamp = Date.now();
            }
            const total = web3.utils.toBN(quantity).mul(web3.utils.toBN(ticketPrice));
            document.getElementById("totalCost").innerText = web3.utils.fromWei(total, "ether");
        }

        // Atualizar saldo
        async function updateWalletBalance() {
            if (!userAddress || !isWalletConnected) {
                document.getElementById("walletBalance").innerText = "0 MON";
                return;
            }
            try {
                const balance = await web3.eth.getBalance(userAddress);
                document.getElementById("walletBalance").innerText = `${parseFloat(web3.utils.fromWei(balance, "ether")).toFixed(2)} MON`;
            } catch (error) {
                console.error("Erro ao obter saldo:", error);
                document.getElementById("walletBalance").innerText = "Erro";
            }
        }

        // Função de retry para erros 429
        async function retryCall(callFn, maxRetries = 3, baseDelay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await callFn();
                } catch (error) {
                    if (error.message.includes("429") || error.message.includes("request limit reached")) {
                        if (attempt === maxRetries) {
                            throw new Error("Limite de requisições atingido. Tente novamente em alguns minutos.");
                        }
                        const delay = baseDelay * Math.pow(2, attempt - 1);
                        console.warn(`Erro 429, tentando novamente após ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Atualizar botão de compra
        function updateBuyButton(isRaffleOpen = true) {
            const buyButton = document.getElementById("buyTickets");
            const raffleStatus = document.getElementById("raffleStatus");
            if (!isWalletConnected) {
                buyButton.innerText = "Conecte sua wallet primeiro";
                buyButton.disabled = true;
                buyButton.classList.remove("bg-green-600", "hover:bg-green-700");
                buyButton.classList.add("bg-gray-600", "cursor-not-allowed");
                buyButton.onclick = null;
                raffleStatus.classList.add("hidden");
            } else if (!isRaffleOpen) {
                buyButton.innerText = "Comprar Tickets";
                buyButton.disabled = true;
                buyButton.classList.remove("bg-green-600", "hover:bg-green-700");
                buyButton.classList.add("bg-gray-600", "cursor-not-allowed");
                buyButton.onclick = null;
                raffleStatus.classList.remove("hidden");
            } else {
                buyButton.innerText = "Comprar Tickets";
                buyButton.disabled = false;
                buyButton.classList.remove("bg-gray-600", "cursor-not-allowed");
                buyButton.classList.add("bg-green-600", "hover:bg-green-700");
                buyButton.onclick = debounce(handleBuyTickets, 500);
                raffleStatus.classList.add("hidden");
            }
        }

        // Comprar tickets
        async function handleBuyTickets() {
            if (isProcessing) {
                showErrorPopup("Uma transação está em andamento. Por favor, aguarde.");
                return;
            }
            if (!isWalletConnected) {
                showErrorPopup("Conecte sua carteira primeiro.");
                return;
            }
            isProcessing = true;
            try {
                const isRaffleOpen = await retryCall(() => contract.methods.isRaffleOpen().call());
                if (!isRaffleOpen) {
                    showErrorPopup("O sorteio está fechado. Aguarde o próximo sorteio.");
                    return;
                }
                const alias = normalizeXUsername(Cookies.get("xUsername") || "");
                const quantity = parseInt(document.getElementById("ticketQuantity").value) || 1;
                if (!alias || !isValidXUsername(alias)) {
                    showErrorPopup("Insira um username válido do X (ex.: @username) no menu da carteira.");
                    return;
                }
                const ticketPrice = await retryCall(() => contract.methods.ticketPrice().call());
                const totalValue = web3.utils.toBN(quantity).mul(web3.utils.toBN(ticketPrice)).toString();
                await contract.methods.buyTickets(quantity, alias).send({
                    from: userAddress,
                    value: totalValue
                });
                showThanksPopup();
                cache = { data: null, timestamp: 0, validDuration: 60000 };
                await updateUI();
            } catch (error) {
                console.error("Erro ao comprar tickets:", error);
                if (error.message.includes("user rejected") || error.code === 4001) {
                    showErrorPopup("Você cancelou a transação no MetaMask. Por favor, autorize a transação para continuar.");
                } else if (error.message.includes("Raffle is not open")) {
                    showErrorPopup("O sorteio está fechado. Aguarde o próximo sorteio.");
                } else {
                    showErrorPopup(error.message || "Erro ao comprar tickets. Verifique seu saldo e tente novamente.");
                }
            } finally {
                isProcessing = false;
            }
        }

        // Fechar menu da carteira
        function setupMenuCloseListener() {
            document.addEventListener("click", (e) => {
                const walletButton = document.getElementById("walletButton");
                const walletMenu = document.getElementById("walletMenu");
                if (!walletButton.contains(e.target) && !walletMenu.contains(e.target)) {
                    walletMenu.classList.add("hidden");
                }
            });
        }

        // Mostrar popups
        function showErrorPopup(message) {
            document.getElementById("errorMessage").innerText = message.includes("429") || message.includes("request limit reached")
                ? "Limite de requisições atingido. Aguarde alguns minutos e tente novamente."
                : message;
            document.getElementById("errorPopup").style.display = "block";
            document.getElementById("popupOverlay").style.display = "block";
        }

        function showThanksPopup() {
            document.getElementById("thanksPopup").style.display = "block";
            document.getElementById("popupOverlay").style.display = "block";
        }

        function hidePopup(popupId) {
            document.getElementById(popupId).style.display = "none";
            if (popupId === "thanksPopup") {
                document.getElementById("errorPopup").style.display = "none";
            }
            if (document.getElementById("errorPopup").style.display !== "block" &&
                document.getElementById("thanksPopup").style.display !== "block" &&
                document.getElementById("usernamePopup").style.display !== "block" &&
                document.getElementById("cookieConsent").style.display !== "block") {
                document.getElementById("popupOverlay").style.display = "none";
            }
        }

        // Aceitar cookies
        function acceptCookies() {
            Cookies.set("acceptedCookies", "true", { expires: 365 });
            document.getElementById("cookieConsent").style.display = "none";
        }

        // Efeito 3D na imagem
        function setupImage3DEffect() {
            const image = document.getElementById("sorteioImage");
            const imageRect = image.getBoundingClientRect();
            image.addEventListener("mousemove", (e) => {
                const x = e.clientX - imageRect.left;
                const y = e.clientY - imageRect.top;
                const centerX = imageRect.width / 2;
                const centerY = imageRect.height / 2;
                const maxTilt = 20;
                const tiltX = ((centerY - y) / centerY) * maxTilt;
                const tiltY = ((x - centerX) / centerX) * maxTilt;
                image.style.transform = `perspective(1000px) rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;
            });
            image.addEventListener("mouseleave", () => {
                image.style.transform = "perspective(1000px) rotateX(0deg) rotateY(0deg)";
            });
        }

        // Atualizar interface
        async function updateUI() {
            if (!userAddress || !isWalletConnected) {
                document.getElementById("walletButton").innerText = "Conectar Carteira";
                document.getElementById("walletMenu").classList.add("hidden");
                document.getElementById("ticketPrice").innerText = "0.01";
                document.getElementById("participantCount").innerText = "0";
                document.getElementById("ticketCount").innerText = "0";
                document.getElementById("participantsList").innerHTML = "";
                document.getElementById("pastWinnersList").innerHTML = "";
                document.getElementById("participantsSection").style.display = "none";
                document.getElementById("winnersSection").style.display = "none";
                document.getElementById("walletBalance").innerText = "0 MON";
                updateBuyButton(true); // Assume sorteio aberto para usuários desconectados
                return;
            }
            try {
                let ticketPrice, ticketCount, participants, pastWinners, isRaffleOpen;
                if (cache.data && Date.now() - cache.timestamp < cache.validDuration) {
                    ({ ticketPrice, ticketCount, participants, pastWinners, isRaffleOpen } = cache.data);
                } else {
                    ticketPrice = await retryCall(() => contract.methods.ticketPrice().call());
                    ticketCount = await retryCall(() => contract.methods.getTicketCount(userAddress).call());
                    participants = await retryCall(() => contract.methods.getParticipants().call());
                    pastWinners = await retryCall(() => contract.methods.getPastWinners().call());
                    isRaffleOpen = await retryCall(() => contract.methods.isRaffleOpen().call());
                    cache.data = { ticketPrice, ticketCount, participants, pastWinners, isRaffleOpen };
                    cache.timestamp = Date.now();
                }
                document.getElementById("ticketPrice").innerText = web3.utils.fromWei(ticketPrice, "ether");
                document.getElementById("participantCount").innerText = participants.length;
                document.getElementById("ticketCount").innerText = ticketCount;
                await updateTotalCost();
                await updateWalletBalance();
                updateBuyButton(isRaffleOpen);
                const participantsList = document.getElementById("participantsList");
                participantsList.innerHTML = "";
                const participantData = [];
                for (let i = 0; i < Math.min(participants.length, 5); i++) {
                    const participant = participants[i];
                    if (!web3.utils.isAddress(participant)) continue;
                    const alias = await retryCall(() => contract.methods.getAlias(participant).call());
                    const count = await retryCall(() => contract.methods.getTicketCount(participant).call());
                    participantData.push({ address: participant, alias, count });
                }
                participantData.sort((a, b) => b.count - a.count);
                document.getElementById("participantsSection").style.display = participantData.length > 0 ? "block" : "none";
                participantData.forEach(({ address, alias, count }, i) => {
                    const li = document.createElement("li");
                    li.innerText = `${i + 1}º - ${truncateAddress(address)} (${alias}): ${count} tickets`;
                    participantsList.appendChild(li);
                });
                const pastWinnersList = document.getElementById("pastWinnersList");
                pastWinnersList.innerHTML = "";
                const winnerData = [];
                for (const winner of pastWinners.slice(0, 5)) {
                    if (!web3.utils.isAddress(winner)) continue;
                    const alias = await retryCall(() => contract.methods.getAlias(winner).call());
                    winnerData.push({ address: winner, alias });
                }
                document.getElementById("winnersSection").style.display = winnerData.length > 0 ? "block" : "none";
                for (const { address, alias } of winnerData) {
                    const li = document.createElement("li");
                    li.innerText = `${truncateAddress(address)} (${alias})`;
                    pastWinnersList.appendChild(li);
                }
            } catch (error) {
                console.error("Erro ao atualizar UI:", error);
                showErrorPopup(error.message || "Erro ao atualizar interface.");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
